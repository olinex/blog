---
description: '本文章由olinex翻译, 转载请在页面开头标明出处'
---

# 网桥

从网络角度来看, 网桥是一种链接层设备, 它转发了网段之间的流量. 网桥可以是主机中运行的硬件, 也可以是软件设备.

从 Docker 角度来看, 网桥网络使用了软件来桥接, 它允许连接同一个网桥网络的容器进行通信, 同时将未连接到网桥的容器与网桥内的容器隔离. Docker 网桥驱动会自动地在主机上安装规则, 因此在不同网桥网络内的容器不能直接访问彼此.

网桥网络适用于运行在同一台 Docker 守护进程下的容器, 要让运行在不同守护进程下的容器通信, 你可以通过修改系统层次的路由, 或者你可以使用 [覆盖网络](fu-gai.md) .

当 Docker 启动后, 默认的 网桥网络 \(名为 bridge\) 会自动创建, 后续新创建的容器将会默认使用这个网络. 你还可以自定义网桥网络, 它优先于默认的网桥网络 - `bridge` .

### 自定义网桥与默认网桥的区别

#### 自定义网桥可以为容器化的应用提供了更好的隔离和互操作性

连接在同一个网桥网络内的容器会自动为彼此开放所有的端口, 并且对外关闭所有的端口. 这可以让容器化的应用能更加轻松的与彼此通讯, 而不需要担心一不小心对外暴露了接口.

想象一下, 一个由前端网站和后端数据库组成的应用栈. 外部需要能够访问前端网站 \(例如通过 80 端口\) , 但是只有后端自身能够访问数据库的主机和端口. 通过自定义网桥, 只需要开启网站的端口, 而后端数据库应用不需要开启任何端口, 前端网站可以通过自定义网桥网络访问数据库.

如果你在默认的网桥网络内运行以上的应用栈, 你需要通过 `-p` 或 `--publish` 仓库来同时开启网站端口和数据库端口. 这意味着 Docker 主机需要通过别的方式来限制数据库端口的访问.

#### 自定义网桥自动为容器提供了DNS解析

在默认的网桥网络内, 容器间只能通过 IP 地址访问呢彼此, 除非你使用 `--link` 参数 \(将会被废弃\) . 而在自定义网桥网络内, 容器可以通过名称或者别名访问彼此.

想象一下刚刚提到的应用, 一个前端网站和后端数据库. 如果为他们命名为 `web` 和 `db` , 网站容器可以通过名称 `db` 来访问数据库容器, 无论应用栈运行在哪个 Docker 主机上.

如果你在默认的网桥网络内运行相同的应用栈, 你需要在容器之间创建连接 \(通过遗留的 --link 参数\) . 并且需要同时创建两个方向的连接, 因此你可以看见, 当两个以上的容器需要互相访问, 这会变得非常复杂. 或者, 你可以修改容器内的 `/etc/hosts` 文件, 但是这会让后续的调试非常困难.

#### 自定义网桥可以在运行时连接和断开容器

在容器的生命周期内, 你可以在运行的时候连接或断开与自定义网桥的连接. 而要从默认的网桥网络中移出容器, 你需要先停止容器并且重新创建.

#### 每个自定义网络将会创建一个可配置的网桥

如果你的容器使用了默认的网桥网络, 你可以配置它, 但所有的容器都讲使用相同的配置, 例如 MTU 和 iptables 规则. 并且默认网桥网络需要重新启动 Docker.

自定义网桥通过 `docker network create` 命令来创建和配置. 如果不同的一系列应用需要使用不同的网络, 你可以在创建网络的时候对每个自定义网桥进行配置.

#### 共享环境变量

一开始, 要让两个容器能够共享环境变量, 就是通过 --link 参数 将他们连接起来. 这种共享方式是无法在自定义网桥中使用的, 但是, 有一些更加有效的方式来共享环境变量, 例如:

* 多个容器可以通过 Docker 卷来加载保存了共享信息的文件或文件夹
* 多个容器可以通过 `docker-compose` 来一起启动, 编排文件可以定义这些共享变量
* 你可以通过集群服务来替代独立的容器, 并使用 docker secret 和 docker config 来共享变量

连接了同一个自定义网桥网络的容器会为彼此开放所有的端口. 对于其他网络或者不同的主机, 必须通过 `-p` 或者 `--publish` 仓库来开放端口才能访问.

## 管理自定义网桥

创建自定义网桥:

```bash
docker network create my-net
```

你可以配置它的子网络, IP 地址范围, 网关和其他参数. 通过 docker network create --help 可以产看更多帮助.

删除自定义网桥:

```bash
docker network rm my-net
```

如果已经有容器接入了网络, 需要先端来连接.

{% hint style="info" %}
当你创建或删除自定义网桥, 或者是容器连接或断开自定义网桥的时候, Docker 使用特定于操作系统的工具管理底层网络的结构 \(例如添加或删除网桥驱动, 或修改 iptables 的规则配置\) . 这些是实现的细节, 只需要让 Docker 来帮你管理就好了.
{% endhint %}

## 连接至自定义网桥

当你创建一个新的容器后, 你需要指定一个或多个 `--network` 参数. 以下例子将 Nginx 容器连接到 `my-net` 网络. 同时将容器内的 80 端口通过主机的 8080 来开放, 来让其他的客户端可以访问这个端口. 任何其他连接到 `my-net` 网络的容器都能访问 `my-nginx` 容器的所有端口 ,反之亦然.

```bash
docker create --name my-nginx \
--network my-net \
--publish 8080:80 \
nginx:lastest
```

想要将正在运行的容器连接到指定的自定义容器, 可以使用 `docker network connect` 命令:

```bash
docker network connect my-net my-nginx
```

## 从自定义网桥断开

想要将正在运行的容器从指定的自定义容器中断开, 可以使用 docker network disconnect 命令:

```bash
docker network disconnect my-net ny-nginx
```

## 从 Docker 容器访问外部网络

默认情况下, 当容器连接默认网桥网络时, 不允许从容器连接连接到外部网络, 你需要修改两个设置来开启. 这些不是 Docker 的命令并且会对主机的内核有影响:

* 修改 Linux 内核的配置来运行 IP 访问

```bash
sysctl net.ipv4.conf.all.forwarding=1
```

* 修改 iptables FORWARD 策略

```bash
sudo iptables -P FORWARD ACCEPT
```

{% hint style="info" %}
这些配置会在重启后失效, 你可以将加入启动脚本
{% endhint %}

